# SPDX-FileCopyrightText: 2025 Contributors to the OpenSTEF project <short.term.energy.forecasts@alliander.com>
#
# SPDX-License-Identifier: MPL-2.0

name: Quality Checks
concurrency:
  # means: only one run with this name (the workflow name) can run in parallel.
  # An in progress job will carry on, but old pending jobs will be replaced by the new one.
  group: ${{ github.workflow }}

on:
  # push:
    # push to the base branch (the branch to be merged into)
    # branches: [main, develop] # Uncomment when v4.0.0 is merged into main.

  pull_request:
    # synchronize: HEAD branch is updated.
    # Aka: push to the branch *to be merged* (NOT to the base branch, aka the branch to be merged into)
    # PR merged is done in trigger_acc_prd.yaml
    types: [opened, synchronize, reopened, closed]
  
  # Run pipeline from another workflow
  workflow_call:
  # Run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout # Must be done before using composite actions
        uses: actions/checkout@v4
        with:
          show-progress: false # very verbose for not much
      - name: Install uv
        uses: astral-sh/setup-uv@v6
        # uv is needed for qa and deploy, so is kinda always needed. No need to skip it.
        with:
          activate-environment: true
          enable-cache: true
      - name: Install dependencies
        if: ${{ always() }}
        run: uv sync --frozen --no-install-project --all-groups --all-extras

      # Run quality checks
      - name: reuse
        if: ${{ always() }}
        run: poe reuse
      - name: lint
        if: ${{ always() }}
        run: poe lint --check
      - name: format
        if: ${{ always() }}
        run: poe format --check
      - name: format-pyproject
        if: ${{ always() }}
        run: poe format-pyproject --check
      - name: typing
        if: ${{ always() }}
        run: poe type
      - name: tests
        if: ${{ always() }}
        run: poe tests
      - name: doctests
        if: ${{ always() }}
        run: poe doctests

      - name: Upload coverage report for GitHub Checks
        uses: github/codeql-action/upload-code-coverage@v2
        with:
          coverage_format: cobertura
          path_to_coverage: coverage.xml

      - name: Stop if any quality step failed
        # All tests are run with always() not to stop on the first error. This step makes the workflow fail if any quality step failed.
        if: ${{ failure() }}
        run: exit 1